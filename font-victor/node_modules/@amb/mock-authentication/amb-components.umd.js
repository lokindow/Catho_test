!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@amb/core")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@amb/core"],t):t(e["amb-components"]={},e.core,e.core$1)}(this,function(e,t,r){"use strict";var o,n=function(){function e(){this._usersMock=[]}return Object.defineProperty(e.prototype,"usersMock",{get:function(){return this._usersMock},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[]},e}(),i=(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t}(r.AMBException),a=function(){function e(e,t,o){this._authenticated=!1,this._delayDuration=3e3,this._authorization=e,this._mockFile=t,this._mapping=o,this._storage=r.AMBServiceContainer.get(r.AMBServiceType.AMBStorage),this._logger=r.AMBServiceContainer.get(r.AMBServiceType.Logger.ConsoleLogger);try{var n=atob(this._storage.getItem(r.AMBUser._userKey)),i=JSON.parse(n);this._user=new r.AMBUser(i._name,i._username,i._roles)}catch(e){this._logger.log("Não foi possível recuperar o usuário da sessão",4),this._user=void 0}void 0!==this._user?(this._authorization.ambUser=this._user,this._authorization.emitChanges(this._user,"restore"),this._authenticated=!0):(this._user=new r.AMBUser,this._authorization.emitChanges(this._user,null),this._storage.removeItem(r.AMBUser._userKey),this._authenticated=!1)}return e.prototype.isAuthenticated=function(){return this._authenticated},e.prototype.login=function(e,t){var o=this;return this._user=void 0,this._authenticated=!1,this._storage.removeItem(r.AMBUser._userKey),this._storage.removeItem(r.AMBUser._authKey),this._authorization.emitChanges(this._user,"loginInit"),r.Observable.create(function(n){for(var i=0,a=o._mockFile.usersMock;i<a.length;i++){var u=a[i];if(u.username.toLowerCase()===e.toLowerCase()&&u.password===t){o._user=new r.AMBUser;for(var c=0,_=u.groups;c<_.length;c++)for(var h=_[c],p=0,g=o._mapping.mapping;p<g.length;p++){var f=g[p];f.groups.indexOf(h)>-1&&o._user.add(f.role)}o._user.username=u.name,o._user.name=u.username,o._authenticated=!0,o._authorization.emitChanges(o._user,"login");var l=new r.AMBStorageObject;l.key=r.AMBUser._userKey,l.value=btoa(JSON.stringify(o._user)),o._storage.setItem(l,!0);var m=new r.AMBStorageObject;m.key=r.AMBUser._authKey,m.value=btoa(e+":"+t),o._storage.setItem(m,!0),o._logger.log("Usuário: "+e+" autenticado com sucesso",2);break}}if(!o._authenticated){var d=new s("Usuário e/ou senha inválido(s)");throw o._logger.log("Problema autenticando o usuário: "+e,4),d}n.next(o._user)})},e.prototype.logoff=function(){var e=this;return r.Observable.create(function(t){setTimeout(function(){e._user=void 0,e._authenticated=!1,e._storage.removeItem(r.AMBUser._userKey),e._storage.removeItem(r.AMBUser._authKey),t.next(!0),e._authorization.emitChanges(e._user,"logoff")},e._delayDuration)})},Object.defineProperty(e.prototype,"user",{get:function(){return void 0===this._user&&(this._user=new r.AMBUser),this._user},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:r.AMBAuthorization},{type:n},{type:r.AMBRolesMapping}]},e}(),u=function(){function e(e){}return e.forRoot=function(){return{ngModule:e}},e.decorators=[{type:t.NgModule,args:[{declarations:[],imports:[],exports:[],providers:[n,{provide:r.AMBAuthentication,useClass:a}]}]}],e.ctorParameters=function(){return[{type:r.AMBAuthentication}]},e}();e.AMBMockeAuthenticationModule=u,e.AMBMockedAuthentication=a,e.AMBMockFile=n,Object.defineProperty(e,"__esModule",{value:!0})});